workspace:
  base: /go
  path: src/github.com/kowala-tech/kcoin

clone:
  git:
    image: plugins/git
    tags: true

pipeline:
  test:
    group: testing
    image: kowalatech/go:1.0.3
    commands:
      - make test
      - make lint
    when:
      event: [pull_request]

  # Builds the docker image that's going to be used in the `e2e` step right into the docker service.
  docker-image-for-e2e:
    image: docker
    environment:
    - DOCKER_HOST=tcp://docker:2375
    commands: 
    - docker build -t kowalatech/kusd:dev -f kcoin.Dockerfile .
    when:
      event: [pull_request]

  e2e:
    image: kowalatech/e2e:latest
    environment:
    - DOCKER_HOST=tcp://docker:2375
    - DOCKER_PUBLIC_IP=docker
    commands: 
    - /e2e
    when:
      event: [pull_request]

  build:
    image: kowalatech/go:1.0.3
    commands:
      - make
    when:
      event: [push, tag]
      branch: [master, dev, refs/tags/*]

  docker_kusd_dev:
    group: docker-deployment
    image: plugins/docker
    repo: kowalatech/kusd
    secrets: [ docker_username, docker_password ]
    tags: dev
    dockerfile: kcoin.Dockerfile
    when:
      branch: [dev]
      event: [push, tag]

  docker_bootnode_dev:
    group: docker-deployment
    image: plugins/docker
    repo: kowalatech/bootnode
    secrets: [ docker_username, docker_password ]
    tags: dev
    dockerfile: bootnode.Dockerfile
    when:
      branch: [dev]
      event: [push, tag]

  docker_faucet_dev:
    group: docker-deployment
    image: plugins/docker
    repo: kowalatech/faucet
    secrets: [ docker_username, docker_password ]
    tags: dev
    dockerfile: faucet.Dockerfile
    when:
      branch: [dev]
      event: [push, tag]

  docker_kusd_tag:
    group: docker-deployment
    image: kowalatech/drone-docker
    repo: kowalatech/kusd
    secrets: [ docker_username, docker_password ]
    privileged: true
    auto_tag: true
    dockerfile: kcoin.Dockerfile
    when:
      event: tag

  docker_bootnode_tag:
    group: docker-deployment
    image: kowalatech/drone-docker
    repo: kowalatech/bootnode
    secrets: [ docker_username, docker_password ]
    privileged: true
    auto_tag: true
    dockerfile: bootnode.Dockerfile
    when:
      event: tag

  docker_faucet_tag:
    group: docker-deployment
    image: kowalatech/drone-docker
    repo: kowalatech/faucet
    secrets: [ docker_username, docker_password ]
    privileged: true
    auto_tag: true
    dockerfile: faucet.Dockerfile
    when:
      event: tag

  build-artifacts:
    image: kowalatech/go:1.0.3
    environment:
      - DOCKER_HOST=tcp://docker:2375
    commands:
      - make kcoin-cross
    when:
      event: [push, tag]
      branch: [dev]

  s3:
    image: plugins/s3
    bucket: releases.kowala.io
    region: us-east-1
    acl: public-read
    source: build/bin/kcoin-*.zip
    strip_prefix: build/bin/
    target: /
    secrets: [aws_access_key_id, aws_secret_access_key]
    when:
      event: [push, tag]
      branch: [dev]

services:
  docker:
    image: docker:dind
    command: [ '-l', 'fatal' ]
    privileged: true
